import json
from fairgraph import KGClient
from fairgraph.queries import Query, QueryProperty as QP
import fairgraph.openminds.core as omcore
import fairgraph.openminds.ephys as ephys
import fairgraph.openminds.stimulation as omstim

vocab = "https://openminds.ebrains.eu/vocab/"
client = KGClient(host="core.kg.ebrains.eu")


Q_device = QP(
    f"{vocab}device",
    name="device",
    expect_single=True,
    properties=[
        QP(f"{vocab}lookupLabel", name="label"),
        QP(f"{vocab}name", name="name"),
        QP("@type"),
        QP(f"{vocab}internalIdentifier", name="internalIdentifier"),
        QP(f"{vocab}description", name="description"),
        QP(
            f"{vocab}deviceType",
            name="deviceType",
            expect_single=True,
            properties=[
                QP(f"{vocab}name", name="name"),
            ],
        ),
        QP(
            f"{vocab}manufacturer",
            name="manufacturer",
            expect_single=True,
            properties=[
                QP(f"{vocab}shortName", name="shortName"),
                QP(f"{vocab}fullName", name="fullName"),
            ],
        ),
    ],
)

Q_tissue_bath_solution = QP(
    f"{vocab}tissueBathSolution",
    name="tissueBathSolution",
    expect_single=True,
    properties=[
        QP(f"{vocab}name", name="name"),
        QP("@type"),
    ],
)


query = Query(
    node_type=omcore.DatasetVersion.type_[0],
    space=None,
    properties=[
        QP(f"{vocab}fullName", name="fullName"),
        QP("@type"),
        QP(
            f"{vocab}studiedSpecimen",
            name="subjects",
            type_filter=omcore.Subject.type_[0],
            properties=[
                QP(f"{vocab}lookupLabel", name="label"),
                QP("@type"),
                QP(
                    f"{vocab}studiedState",
                    name="states",
                    properties=[
                        QP(f"{vocab}lookupLabel", name="label"),
                        QP("@type"),
                        QP(
                            f"{vocab}age",
                            name="age",
                            expect_single=True,
                            properties=[
                                QP(f"{vocab}value", name="value"),
                                QP(
                                    f"{vocab}unit",
                                    name="units",
                                    expect_single=True,
                                    properties=[QP(f"{vocab}name", name="name")],
                                ),
                                QP(f"{vocab}minValue", name="minValue"),
                                QP(f"{vocab}maxValue", name="maxValue"),
                                QP(
                                    f"{vocab}minValueUnit",
                                    name="minValueUnit",
                                    expect_single=True,
                                    properties=[QP(f"{vocab}name", name="name")],
                                ),
                                QP(
                                    f"{vocab}maxValueUnit",
                                    name="maxValueUnit",
                                    expect_single=True,
                                    properties=[QP(f"{vocab}name", name="name")],
                                ),
                            ],
                        ),
                        QP(
                            f"{vocab}ageCategory",
                            name="ageCategory",
                            expect_single=True,
                            properties=[QP(f"{vocab}name", name="name")],
                        ),
                        QP(
                            f"{vocab}pathology",
                            name="pathologies",
                            properties=[QP(f"{vocab}name", name="name")],
                        ),
                        QP(
                            f"{vocab}input",
                            reverse=True,
                            name="slicePreparation",
                            properties=[
                                QP(f"{vocab}lookupLabel", name="label"),
                                QP("@type"),
                                QP(
                                    f"{vocab}device",
                                    name="deviceUsage",
                                    properties=[
                                        QP("@type"),
                                        QP(f"{vocab}lookupLabel", name="label"),
                                        Q_device,
                                        QP(
                                            f"{vocab}sliceThickness",
                                            name="sliceThickness",
                                            expect_single=True,
                                            properties=[
                                                QP(f"{vocab}value", name="value"),
                                                QP(
                                                    f"{vocab}unit",
                                                    name="units",
                                                    expect_single=True,
                                                    properties=[
                                                        QP(f"{vocab}name", name="name")
                                                    ],
                                                ),
                                            ],
                                        ),
                                        QP(
                                            f"{vocab}slicingPlane",
                                            name="slicingPlane",
                                            expect_single=True,
                                            properties=[
                                                QP(f"{vocab}name", name="name")
                                            ],
                                        ),
                                    ],
                                ),
                                QP(
                                    f"{vocab}studyTarget",
                                    name="studyTargets",
                                    properties=[QP(f"{vocab}name", name="name")],
                                ),
                                QP(
                                    f"{vocab}temperature",
                                    name="temperature",
                                    expect_single=True,
                                    properties=[
                                        QP(f"{vocab}value", name="value"),
                                        QP(
                                            f"{vocab}unit",
                                            name="units",
                                            expect_single=True,
                                            properties=[
                                                QP(f"{vocab}name", name="name")
                                            ],
                                        ),
                                    ],
                                ),
                                Q_tissue_bath_solution,
                                QP(
                                    f"{vocab}output",
                                    name="slices",
                                    properties=[
                                        QP(f"{vocab}lookupLabel", name="label"),
                                        QP("@type"),
                                        QP(
                                            f"{vocab}internalIdentifier",
                                            name="internalIdentifier",
                                        ),
                                        QP(
                                            f"{vocab}studiedState",
                                            name="slice",
                                            reverse=True,
                                            expect_single=True,
                                            properties=[
                                                QP(f"{vocab}lookupLabel", name="label"),
                                                QP("@type"),
                                                QP(
                                                    f"{vocab}internalIdentifier",
                                                    name="internalIdentifier",
                                                ),
                                                QP(
                                                    f"{vocab}anatomicalLocation",
                                                    name="anatomicalLocation",
                                                    # todo: add some more properties here for link out
                                                    properties=[
                                                        QP(f"{vocab}name", name="name"),
                                                        QP("@type"),
                                                    ],
                                                ),
                                                QP(
                                                    f"{vocab}type",
                                                    name="sampleType",
                                                    properties=[
                                                        QP(f"{vocab}name", name="name"),
                                                        QP("@type"),
                                                    ],
                                                ),
                                            ],
                                        ),
                                        QP(
                                            f"{vocab}input",
                                            reverse=True,
                                            name="cellPatching",
                                            properties=[
                                                QP(f"{vocab}lookupLabel", name="label"),
                                                QP("@type"),
                                                QP(
                                                    f"{vocab}device",
                                                    name="deviceUsage",
                                                    properties=[
                                                        QP("@type"),
                                                        QP(
                                                            f"{vocab}lookupLabel",
                                                            name="label",
                                                        ),
                                                        Q_device,
                                                        QP(
                                                            f"{vocab}pipetteSolution",
                                                            name="pipetteSolution",
                                                            expect_single=True,
                                                            properties=[
                                                                QP(
                                                                    f"{vocab}name",
                                                                    name="name",
                                                                ),
                                                                QP("@type"),
                                                            ],
                                                        ),
                                                        QP(
                                                            f"{vocab}sealResistance",
                                                            name="sealResistance",
                                                            expect_single=True,
                                                            properties=[
                                                                QP(
                                                                    f"{vocab}value",
                                                                    name="values",
                                                                    properties=[
                                                                        QP(
                                                                            f"{vocab}value",
                                                                            name="value",
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}unit",
                                                                            name="units",
                                                                            expect_single=True,
                                                                            properties=[
                                                                                QP(
                                                                                    f"{vocab}name",
                                                                                    name="name",
                                                                                )
                                                                            ],
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}minValue",
                                                                            name="minValue",
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}maxValue",
                                                                            name="maxValue",
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}minValueUnit",
                                                                            name="minValueUnits",
                                                                            expect_single=True,
                                                                            properties=[
                                                                                QP(
                                                                                    f"{vocab}name",
                                                                                    name="name",
                                                                                )
                                                                            ],
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}maxValueUnit",
                                                                            name="maxValueUnits",
                                                                            expect_single=True,
                                                                            properties=[
                                                                                QP(
                                                                                    f"{vocab}name",
                                                                                    name="name",
                                                                                )
                                                                            ],
                                                                        ),
                                                                    ],
                                                                ),
                                                            ],
                                                        ),
                                                        QP(
                                                            f"{vocab}seriesResistance",
                                                            name="seriesResistance",
                                                            expect_single=True,
                                                            properties=[
                                                                QP(
                                                                    f"{vocab}value",
                                                                    name="values",
                                                                    properties=[
                                                                        QP(
                                                                            f"{vocab}value",
                                                                            name="value",
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}unit",
                                                                            name="units",
                                                                            expect_single=True,
                                                                            properties=[
                                                                                QP(
                                                                                    f"{vocab}name",
                                                                                    name="name",
                                                                                )
                                                                            ],
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}minValue",
                                                                            name="minValue",
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}maxValue",
                                                                            name="maxValue",
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}minValueUnit",
                                                                            name="minValueUnits",
                                                                            expect_single=True,
                                                                            properties=[
                                                                                QP(
                                                                                    f"{vocab}name",
                                                                                    name="name",
                                                                                )
                                                                            ],
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}maxValueUnit",
                                                                            name="maxValueUnits",
                                                                            expect_single=True,
                                                                            properties=[
                                                                                QP(
                                                                                    f"{vocab}name",
                                                                                    name="name",
                                                                                )
                                                                            ],
                                                                        ),
                                                                    ],
                                                                )
                                                            ],
                                                        ),
                                                        QP(
                                                            f"{vocab}holdingPotential",
                                                            name="holdingPotential",
                                                            expect_single=True,
                                                            properties=[
                                                                QP(
                                                                    f"{vocab}value",
                                                                    name="values",
                                                                    properties=[
                                                                        QP(
                                                                            f"{vocab}value",
                                                                            name="value",
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}unit",
                                                                            name="units",
                                                                            expect_single=True,
                                                                            properties=[
                                                                                QP(
                                                                                    f"{vocab}name",
                                                                                    name="name",
                                                                                )
                                                                            ],
                                                                        ),
                                                                    ],
                                                                )
                                                            ],
                                                        ),
                                                    ],
                                                ),
                                                Q_tissue_bath_solution,
                                                QP(
                                                    f"{vocab}bathTemperature",
                                                    name="bathTemperature",
                                                    expect_single=True,
                                                    properties=[
                                                        QP(
                                                            f"{vocab}value",
                                                            name="value",
                                                        ),
                                                        QP(
                                                            f"{vocab}unit",
                                                            name="units",
                                                            expect_single=True,
                                                            properties=[
                                                                QP(
                                                                    f"{vocab}name",
                                                                    name="name",
                                                                )
                                                            ],
                                                        ),
                                                    ],
                                                ),
                                                QP(
                                                    f"{vocab}description",
                                                    name="description",
                                                ),
                                                QP(
                                                    f"{vocab}variation",
                                                    name="variation",
                                                    expect_single=True,
                                                    properties=[
                                                        QP(
                                                            f"{vocab}name",
                                                            name="name",
                                                        )
                                                    ],
                                                ),
                                                QP(
                                                    f"{vocab}output",
                                                    name="patchedCells",
                                                    properties=[
                                                        QP(
                                                            f"{vocab}lookupLabel",
                                                            name="label",
                                                        ),
                                                        QP("@type"),
                                                        QP(
                                                            f"{vocab}studiedState",
                                                            name="cell",
                                                            reverse=True,
                                                            expect_single=True,
                                                            properties=[
                                                                QP(
                                                                    f"{vocab}internalIdentifier",
                                                                    name="internalIdentifier",
                                                                ),
                                                                QP(
                                                                    f"{vocab}type",
                                                                    name="sampleType",
                                                                    expect_single=True,
                                                                    properties=[
                                                                        QP(
                                                                            f"{vocab}name",
                                                                            name="name",
                                                                        ),
                                                                        QP("@type"),
                                                                    ],
                                                                ),
                                                                QP(
                                                                    f"{vocab}anatomicalLocation",
                                                                    name="anatomicalLocation",
                                                                    # todo: add some more properties here for link out
                                                                    properties=[
                                                                        QP(
                                                                            f"{vocab}name",
                                                                            name="name",
                                                                        ),
                                                                        QP("@type"),
                                                                    ],
                                                                ),
                                                            ],
                                                        ),
                                                        QP(
                                                            f"{vocab}input",
                                                            reverse=True,
                                                            type_filter=ephys.RecordingActivity.type_[
                                                                0
                                                            ],
                                                            name="recordingActivity",
                                                            properties=[
                                                                QP(
                                                                    f"{vocab}lookupLabel",
                                                                    name="label",
                                                                ),
                                                                QP("@type"),
                                                                QP(
                                                                    f"{vocab}description",
                                                                    name="description",
                                                                ),
                                                                QP(
                                                                    f"{vocab}internalIdentifier",
                                                                    name="internalIdentifier",
                                                                ),
                                                                QP(
                                                                    f"{vocab}output",
                                                                    name="files",
                                                                    properties=[
                                                                        QP("@id"),
                                                                        QP(
                                                                            f"{vocab}name",
                                                                            name="name",
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}IRI",
                                                                            name="iri",
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}dataType",
                                                                            name="dataType",
                                                                            expect_single=True,
                                                                            properties=[
                                                                                QP(
                                                                                    f"{vocab}name",
                                                                                    name="name",
                                                                                )
                                                                            ],
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}format",
                                                                            name="format",
                                                                            expect_single=True,
                                                                            properties=[
                                                                                QP(
                                                                                    f"{vocab}name",
                                                                                    name="name",
                                                                                )
                                                                            ],
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}hash",
                                                                            name="hash",
                                                                            properties=[
                                                                                QP(
                                                                                    f"{vocab}algorithm",
                                                                                    name="algorithm",
                                                                                ),
                                                                                QP(
                                                                                    f"{vocab}digest",
                                                                                    name="digest",
                                                                                ),
                                                                            ],
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}storageSize",
                                                                            name="size",
                                                                            expect_single=True,
                                                                            properties=[
                                                                                QP(
                                                                                    f"{vocab}value",
                                                                                    name="value",
                                                                                ),
                                                                                QP(
                                                                                    f"{vocab}unit",
                                                                                    name="units",
                                                                                    expect_single=True,
                                                                                    properties=[
                                                                                        QP(
                                                                                            f"{vocab}name",
                                                                                            name="name",
                                                                                        )
                                                                                    ],
                                                                                ),
                                                                            ],
                                                                        ),
                                                                    ],
                                                                ),
                                                                QP(
                                                                    f"{vocab}device",
                                                                    name="recording",
                                                                    properties=[
                                                                        QP(
                                                                            f"{vocab}recordedWith",
                                                                            reverse=True,
                                                                            name="metadata",
                                                                            expect_single=True,
                                                                            properties=[
                                                                                QP(
                                                                                    f"{vocab}name",
                                                                                    name="name",
                                                                                ),
                                                                                QP(
                                                                                    f"{vocab}additionalRemarks",
                                                                                    name="additionalRemarks",
                                                                                ),
                                                                                QP(
                                                                                    f"{vocab}samplingFrequency",
                                                                                    name="samplingFrequency",
                                                                                    expect_single=True,
                                                                                    properties=[
                                                                                        QP(
                                                                                            f"{vocab}value",
                                                                                            name="value",
                                                                                        ),
                                                                                        QP(
                                                                                            f"{vocab}unit",
                                                                                            name="units",
                                                                                            expect_single=True,
                                                                                            properties=[
                                                                                                QP(
                                                                                                    f"{vocab}name",
                                                                                                    name="name",
                                                                                                )
                                                                                            ],
                                                                                        ),
                                                                                    ],
                                                                                ),
                                                                                QP(
                                                                                    f"{vocab}channel",
                                                                                    name="channels",
                                                                                    properties=[
                                                                                        QP(
                                                                                            f"{vocab}internalIdentifier",
                                                                                            name="internalIdentifier",
                                                                                        ),
                                                                                        QP(
                                                                                            f"{vocab}unit",
                                                                                            name="units",
                                                                                            expect_single=True,
                                                                                            properties=[
                                                                                                QP(
                                                                                                    f"{vocab}name",
                                                                                                    name="name",
                                                                                                )
                                                                                            ],
                                                                                        ),
                                                                                    ],
                                                                                ),
                                                                                # todo: channels
                                                                            ],
                                                                        )
                                                                    ],
                                                                ),
                                                            ],
                                                        ),
                                                        QP(
                                                            f"{vocab}input",
                                                            reverse=True,
                                                            type_filter=omstim.StimulationActivity.type_[
                                                                0
                                                            ],
                                                            name="stimulationActivity",
                                                            properties=[
                                                                QP(
                                                                    f"{vocab}lookupLabel",
                                                                    name="label",
                                                                ),
                                                                QP("@type"),
                                                                QP(
                                                                    f"{vocab}stimulus",
                                                                    name="stimulus",
                                                                    properties=[
                                                                        QP(
                                                                            f"{vocab}lookupLabel",
                                                                            name="label",
                                                                        ),
                                                                        QP("@type"),
                                                                        QP(
                                                                            f"{vocab}epoch",
                                                                            name="epoch",
                                                                            expect_single=True,
                                                                            properties=[
                                                                                QP(
                                                                                    f"{vocab}value",
                                                                                    name="value",
                                                                                ),
                                                                                QP(
                                                                                    f"{vocab}unit",
                                                                                    name="units",
                                                                                    expect_single=True,
                                                                                    properties=[
                                                                                        QP(
                                                                                            f"{vocab}name",
                                                                                            name="name",
                                                                                        )
                                                                                    ],
                                                                                ),
                                                                            ],
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}internalIdentifier",
                                                                            name="internalIdentifier",
                                                                        ),
                                                                        QP(
                                                                            f"{vocab}specification",
                                                                            name="specifications",
                                                                            properties=[
                                                                                QP(
                                                                                    f"{vocab}lookupLabel",
                                                                                    name="label",
                                                                                ),
                                                                                QP(
                                                                                    f"{vocab}configuration",
                                                                                    name="configuration",
                                                                                ),
                                                                            ],
                                                                        ),
                                                                    ],
                                                                ),
                                                            ],
                                                        ),
                                                    ],
                                                ),
                                            ],
                                        ),
                                    ],
                                ),
                            ],
                        ),
                    ],
                ),
            ],
        ),
    ],
)

# print(json.dumps(query.serialize(), indent=2))
# print("="*99)
result = client.query(
    query.serialize(),
    instance_id="bd5f91ff-e829-4b85-92eb-fc56991541f1",
    size=1,
    scope="in progress",
).data[0]
print(json.dumps(result, indent=2))
